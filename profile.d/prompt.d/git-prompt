#!/bin/bash 

source ~/.bash/functions

local self_dir=$(script_path $BASH_SOURCE[0])
source $self_dir/utils

function __git_prompt {
    ref=$(git symbolic-ref HEAD 2> /dev/null) || return
    branch_name="(unnamed branch)"     # detached HEAD
    branch_name=${ref#refs/heads/}

    # Based on https://gist.github.com/woods/31967

    # Set color based on clean/staged/dirty
    git_status="$(git status 2> /dev/null)"
    if [[ ${git_status} =~ "working directory clean" ]]; then
        state="${green}"
    elif [[ ${git_status} =~ "Changes to be committed" ]]; then
        state="${yellow}"
    else
        state="${red}"
    fi

    # Set arrow icon based on status against origin.
    [ ! -f .git/FETCH_HEAD ] && fetch_required=1

    origin_outdated="$(find .git/FETCH_HEAD -mmin +5 2>/dev/null | wc -l | bc)"
    if [[ "${origin_outdated}" == "1" ]]; then
        fetch_required=1
    fi

    if [[ "${fetch_required}" == "1" ]]; then
        echo "Remote information is outdated. Running git fetch."
        git fetch --all
    fi

    git_behind="$(git rev-list HEAD..origin/${branch_name} | wc -l | bc)"
    git_ahead="$(git rev-list origin/${branch_name}..HEAD | wc -l | bc)"

    remote=""
    if [[ "${git_behind}" != "0" ]]; then
        remote="${remote}↓"
    fi

    if [[ "${git_ahead}" != "0" ]]; then
        remote="${remote}↑"
    fi

    printf "${white}∓ (${state}${branch_name}${remote}${white})${reset_color} "
}

